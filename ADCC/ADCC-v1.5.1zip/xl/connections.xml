<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<connections xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"><connection id="1" name="Query from RPTSERVER" type="1" refreshedVersion="6" background="1" saveData="1"><dbPr connection="dsn=RPTSERVER;database=rptdb;server=RPTSQL.nsf.gov;port=5000;UID=gyuan;" command="select dbu.name AS db_name, so.name AS tbl_name FROM FLflpdb.dbo.sysobjects so_x000d__x000a_JOIN FLflpdb.dbo.sysusers dbu ON so.uid = dbu.uid_x000d__x000a_WHERE dbu.name = 'flp' AND so.name in ('addl_pi_invl_pars', 'awd_pars', 'awd_pi_copi_pars', 'bibl', 'budg','BUDG_EXPL', 'clbr_affl', 'DMP_PLAN_DOC', 'FAC_EQUP', 'ggpi_trck', 'inst', 'MENT_PLAN_DOC', 'pi', 'pi_copi_char', 'PI_COPI_PRIR_SUPT', 'PROJ_DESC', 'proj_summ', 'PROP_COVR', 'prop_pars', 'PROP_SPCL_ITEM', 'prop_stts_pars', 'prop_subm_ctl', 'supp_dtls', 'tz_ctry_map')_x000d__x000a_and not exists (SELECT su.name FROM FLflpdb.dbo.sysprotects sp_x000d__x000a_ JOIN FLflpdb.dbo.sysusers su on sp.uid = su.uid_x000d__x000a_ WHERE sp.id = so.id and sp.action = 193 and su.name in ('public','ccfuser'))_x000d__x000a_UNION ALL SELECT dbu.name, so.name FROM sysobjects so _x000d__x000a_JOIN sysusers dbu ON so.uid = dbu.uid_x000d__x000a_WHERE dbu.name = 'csd' AND so.name in ('natr_rqst','eps_blip')_x000d__x000a_and not exists (SELECT su.name FROM sysprotects sp_x000d__x000a_ JOIN sysusers su on sp.uid = su.uid_x000d__x000a_ WHERE sp.id = so.id and sp.action = 193 and su.name in ('public','ccfuser'))_x000d__x000a_order by dbu.name, so.name_x000d__x000a_"/></connection><connection id="2" name="Query from RPTSERVER - for project" type="1" refreshedVersion="6" saveData="1"><dbPr connection="dsn=RPTSERVER;database=FLflpdb;server=RPTSQL.nsf.gov;port=5000;UID=gyuan;" command="SET NOCOUNT ON_x000d__x000a_SELECT DISTINCT isnull(prop.lead_prop_id,prop.prop_id) as lead_x000d__x000a_INTO #myLeads -- get distinct project leads fm input list_x000d__x000a_FROM flp.prop_pars prop_x000d__x000a_WHERE (prop.prop_id In ('1624020','1627342','1627343','1627350','1624004','1624023','1733610','1630480'))_x000d__x000a__x000d__x000a_SELECT CASE WHEN prop.lead_prop_id IS NULL THEN 'I' ELSE 'L' END as ILN,_x000d__x000a_ml.lead AS lead, prop.prop_id, c.TEMP_PROP_ID, prop.nsf_rcvd_date, prop.rqst_dol, prop.prop_titl_txt, prop.pi_id_x000d__x000a_INTO #myProjPropPI -- start with project leads_x000d__x000a_FROM #myLeads ml, flp.prop_pars prop, flp.prop_subm_ctl c_x000d__x000a_WHERE ml.lead = prop.prop_id AND prop.prop_id = c.PROP_ID -- add other filters here?_x000d__x000a_DROP TABLE #myLeads_x000d__x000a_INSERT INTO #myProjPropPI -- add all collabs_x000d__x000a_SELECT 'N' AS ILN, prop.lead_prop_id AS lead, prop.prop_id, c.TEMP_PROP_ID, prop.nsf_rcvd_date, prop.rqst_dol, prop.prop_titl_txt, prop.pi_id_x000d__x000a_FROM #myProjPropPI ppp, flp.prop_pars prop, flp.prop_subm_ctl c_x000d__x000a_WHERE ppp.PROP_ID = prop.lead_prop_id And ppp.PROP_ID &lt;&gt; prop.PROP_ID And prop.PROP_ID = c.PROP_ID_x000d__x000a_SELECT lead, SUM(PDOC_REQ_DOL) AS tot_Pdoc_dol,  SUM(PART_SUPT_STPD_DOL) AS tot_Part_Stipend_x000d__x000a_INTO #myBudgTotals_x000d__x000a_FROM (SELECT prop.lead,  budg.PDOC_REQ_DOL, budg.PART_SUPT_STPD_DOL_x000d__x000a_FROM #myProjPropPI prop, flp.budg budg_x000d__x000a_WHERE prop.TEMP_PROP_ID = budg.TEMP_PROP_ID ) Tmp_x000d__x000a_GROUP BY lead_x000d__x000a_-- get culmulative budget total per project_x000d__x000a_SELECT lead, revn_num, SUM(budg_tot_dol) AS cumulative_tot_dol_x000d__x000a_INTO #myCumBudgTotals_x000d__x000a_FROM (SELECT prop.lead, b.prop_id, b.revn_num, b.budg_tot_dol_x000d__x000a_FROM #myProjPropPI prop, rptdb.csd.eps_blip b_x000d__x000a_WHERE prop.PROP_ID = b.PROP_ID And b.revn_num = 0_x000d__x000a_) Tmp_x000d__x000a_GROUP BY lead, revn_num_x000d__x000a_-- get request amount total per project_x000d__x000a_SELECT lead, SUM(rqst_dol) as tot_rqst_dol, CASE WHEN MIN(prop_titl_txt) &lt;&gt; MAX(prop_titl_txt) THEN 'Y' END AS dif_titl_collab_x000d__x000a_INTO #myTotals FROM #myProjPropPI GROUP BY lead_x000d__x000a_-- get other supplement document count for lead proposal only _x000d__x000a_SELECT prop.lead, count(dtls.supp_doc_seq) as oth_supp_cnt INTO #mySupp_x000d__x000a_FROM #myProjPropPI prop JOIN flp.supp_dtls dtls ON prop.TEMP_PROP_ID = dtls.TEMP_PROP_ID WHERE prop.ILN &lt; 'M' GROUP BY prop.lead _x000d__x000a_INSERT INTO #myProjPropPI_x000d__x000a_SELECT 'P' AS ILN, prop.lead, prop.prop_id, prop.TEMP_PROP_ID, prop.nsf_rcvd_date, 0 AS rqst_dol, '' AS prop_titl_txt, addl_pi_invl.pi_id_x000d__x000a_FROM #myProjPropPI prop_x000d__x000a_JOIN flp.addl_pi_invl_pars addl_pi_invl ON prop.prop_id = addl_pi_invl.prop_id_x000d__x000a_SELECT PIs.pi_id, awd.awd_id, awd_pi_copi.proj_role_code, awd.awd_eff_date_x000d__x000a_INTO #myAwds_x000d__x000a_FROM flp.prop_pars prop, flp.awd_pars awd, flp.awd_pi_copi_pars awd_pi_copi,_x000d__x000a_(SELECT DISTINCT pi_id FROM #myProjPropPI) PIs_x000d__x000a_WHERE awd_pi_copi.awd_id = awd.awd_id And PIs.pi_id = awd_pi_copi.pi_id_x000d__x000a_AND awd.awd_id = prop.prop_id AND prop.rcom_awd_istr  not in ('5','8') AND prop.natr_rqst_code not in ('5','A','F') -- remove supplements, etc.;_x000d__x000a_AND awd.awd_eff_date Between {ts '2012-06-02 00:00:00'} And {ts '2017-06-01 00:00:00'}_x000d__x000a_-- get per PI awd detail info_x000d__x000a_SELECT awd.pi_id, count(awd.awd_id) AS NumAwd,  MAX(convert(char(10),awd.awd_eff_date,102)+' '+awd.awd_id+'.'+awd.proj_role_code) AS LastAwd_x000d__x000a_INTO #myAwdInfo_0_x000d__x000a_FROM #myAwds awd_x000d__x000a_GROUP BY awd.pi_id_x000d__x000a_SELECT b.awd_id, SUM(b.budg_splt_tot_dol) as awd_amt _x000d__x000a_INTO #myAwdAmt_x000d__x000a_FROM rptdb.csd.budg_splt b WHERE b.awd_id IN (SELECT DISTINCT SUBSTRING(LastAwd, 12,7) AS LastAwdid FROM #myAwdInfo_0) GROUP BY b.awd_id_x000d__x000a_SELECT awd.pi_id, awd.NumAwd, awd.LastAwd+' $'+convert(varchar(25),amt.awd_amt) as LastAwd _x000d__x000a_INTO #myAwdInfo FROM #myAwdInfo_0 awd JOIN #myAwdAmt amt on substring(awd.LastAwd, 12,7) = amt.awd_id _x000d__x000a_DROP TABLE #myAwdInfo_0  DROP TABLE #myAwdAmt_x000d__x000a_DROP TABLE #myAwds_x000d__x000a_SELECT DISTINCT supt.TEMP_PROP_ID, PIs.pi_id,_x000d__x000a_CASE WHEN CHAR_LENGTH(rtrim(supt.PROJ_TITL_TXT))&gt;0 OR supt.PATH_NAME IS NOT NULL THEN 'Y' ELSE NULL END as cp_chk_x000d__x000a_INTO #myCPSuppInfo_x000d__x000a_FROM_x000d__x000a_(SELECT DISTINCT TEMP_PROP_ID, pi_id FROM #myProjPropPI) PIs_x000d__x000a_JOIN flp.pi ppi ON PIs.pi_id=ppi.pi_id_x000d__x000a_JOIN flp.PI_COPI_PRIR_SUPT supt ON PIs.TEMP_PROP_ID=supt.TEMP_PROP_ID AND PIs.pi_id=ppi.pi_id AND ppi.PI_LAST_NAME=supt.PI_LAST_NAME AND ppi.PI_FRST_NAME=supt.PI_FRST_NAME_x000d__x000a_SELECT id=identity(18), 0 AS seq, p.ILN, p.lead, p.prop_id, p.TEMP_PROP_ID, p.pi_id, pi_copi_char.PI_LAST_NAME, pi_copi_char.pi_emai_addr, inst.inst_shrt_name,_x000d__x000a_a.NumAwd, a.LastAwd, pi_copi_char.PDF_PAGE_CNT AS bio_pg, supt.cp_chk,_x000d__x000a_(SELECT MAX(ca.doc_page_cnt)  FROM flp.clbr_affl ca WHERE p.TEMP_PROP_ID = ca.temp_prop_id AND p.pi_id = ca.pi_id) AS coa_pg_x000d__x000a_INTO #myPPPseq -- seq: Lead is 0  Non-leads co-Pis_x000d__x000a_FROM #myProjPropPI p_x000d__x000a_JOIN flp.pi ppi ON p.pi_id=ppi.pi_id_x000d__x000a_LEFT OUTER JOIN flp.inst inst ON ppi.inst_id=inst.inst_id -- there some PI has no institution_x000d__x000a_LEFT OUTER JOIN flp.pi_copi_char pi_copi_char ON p.TEMP_PROP_ID=pi_copi_char.TEMP_PROP_ID AND p.pi_id = pi_copi_char.pi_id_x000d__x000a_LEFT OUTER JOIN #myAwdInfo a ON p.pi_id = a.pi_id_x000d__x000a_LEFT OUTER JOIN #myCPSuppInfo supt ON p.TEMP_PROP_ID=supt.TEMP_PROP_ID AND p.pi_id = supt.pi_id_x000d__x000a_ORDER BY p.lead, p.ILN, a.NumAwd DESC_x000d__x000a_SELECT lead, MIN(id) as 'start'_x000d__x000a_INTO #myStarts FROM #myPPPseq GROUP BY lead_x000d__x000a_DROP TABLE #myCPSuppInfo_x000d__x000a_DROP TABLE #myAwdInfo_x000d__x000a_DROP TABLE #myProjPropPI_x000d__x000a_UPDATE #myPPPseq SET p.seq = p.id - M.start_x000d__x000a_FROM #myPPPseq p, #myStarts M WHERE p.lead = M.lead_x000d__x000a_DROP TABLE #myStarts_x000d__x000a_SELECT p.lead, MAX(p.seq)+1 AS NumPIs, COUNT(p.bio_pg) AS NumBios,COUNT(p.coa_pg) AS NumCoas,COUNT(p.cp_chk) AS NumCPs, COUNT(p.LastAwd) as NumRPS_x000d__x000a_, MAX(CASE p.seq WHEN 0 THEN p.pi_last_name END) AS pi0_last_name,_x000d__x000a_MAX(CASE p.seq WHEN 0 THEN p.bio_pg END) AS pi0_bio_pg,_x000d__x000a_max(CASE p.seq WHEN 0 THEN p.coa_pg END) AS pi0_coa_pg,_x000d__x000a_MAX(CASE p.seq WHEN 0 THEN p.cp_chk END) AS pi0_cp_chk,_x000d__x000a_MAX(CASE p.seq WHEN 0 THEN p.NumAwd END) AS pi0_num_awd,_x000d__x000a_MAX(CASE p.seq WHEN 0 THEN p.LastAwd END) AS pi0_last_awd,_x000d__x000a_MAX(CASE p.seq WHEN 0 THEN p.pi_emai_addr END) AS pi0_email,_x000d__x000a_MAX(CASE p.seq WHEN 0 THEN p.inst_shrt_name END) AS pi0_inst_x000d__x000a_, MAX(CASE p.seq WHEN 1 THEN p.pi_last_name END) AS pi1_last_name,_x000d__x000a_MAX(CASE p.seq WHEN 1 THEN p.bio_pg END) AS pi1_bio_pg,_x000d__x000a_max(CASE p.seq WHEN 1 THEN p.coa_pg END) AS pi1_coa_pg,_x000d__x000a_MAX(CASE p.seq WHEN 1 THEN p.cp_chk END) AS pi1_cp_chk,_x000d__x000a_MAX(CASE p.seq WHEN 1 THEN p.NumAwd END) AS pi1_num_awd,_x000d__x000a_MAX(CASE p.seq WHEN 1 THEN p.LastAwd END) AS pi1_last_awd,_x000d__x000a_MAX(CASE p.seq WHEN 1 THEN p.pi_emai_addr END) AS pi1_email,_x000d__x000a_MAX(CASE p.seq WHEN 1 THEN p.inst_shrt_name END) AS pi1_inst_x000d__x000a_, MAX(CASE p.seq WHEN 2 THEN p.pi_last_name END) AS pi2_last_name,_x000d__x000a_MAX(CASE p.seq WHEN 2 THEN p.bio_pg END) AS pi2_bio_pg,_x000d__x000a_max(CASE p.seq WHEN 2 THEN p.coa_pg END) AS pi2_coa_pg,_x000d__x000a_MAX(CASE p.seq WHEN 2 THEN p.cp_chk END) AS pi2_cp_chk,_x000d__x000a_MAX(CASE p.seq WHEN 2 THEN p.NumAwd END) AS pi2_num_awd,_x000d__x000a_MAX(CASE p.seq WHEN 2 THEN p.LastAwd END) AS pi2_last_awd,_x000d__x000a_MAX(CASE p.seq WHEN 2 THEN p.pi_emai_addr END) AS pi2_email,_x000d__x000a_MAX(CASE p.seq WHEN 2 THEN p.inst_shrt_name END) AS pi2_inst_x000d__x000a_, MAX(CASE p.seq WHEN 3 THEN p.pi_last_name END) AS pi3_last_name,_x000d__x000a_MAX(CASE p.seq WHEN 3 THEN p.bio_pg END) AS pi3_bio_pg,_x000d__x000a_max(CASE p.seq WHEN 3 THEN p.coa_pg END) AS pi3_coa_pg,_x000d__x000a_MAX(CASE p.seq WHEN 3 THEN p.cp_chk END) AS pi3_cp_chk,_x000d__x000a_MAX(CASE p.seq WHEN 3 THEN p.NumAwd END) AS pi3_num_awd,_x000d__x000a_MAX(CASE p.seq WHEN 3 THEN p.LastAwd END) AS pi3_last_awd,_x000d__x000a_MAX(CASE p.seq WHEN 3 THEN p.pi_emai_addr END) AS pi3_email,_x000d__x000a_MAX(CASE p.seq WHEN 3 THEN p.inst_shrt_name END) AS pi3_inst_x000d__x000a_, MAX(CASE p.seq WHEN 4 THEN p.pi_last_name END) AS pi4_last_name,_x000d__x000a_MAX(CASE p.seq WHEN 4 THEN p.bio_pg END) AS pi4_bio_pg,_x000d__x000a_max(CASE p.seq WHEN 4 THEN p.coa_pg END) AS pi4_coa_pg,_x000d__x000a_MAX(CASE p.seq WHEN 4 THEN p.cp_chk END) AS pi4_cp_chk,_x000d__x000a_MAX(CASE p.seq WHEN 4 THEN p.NumAwd END) AS pi4_num_awd,_x000d__x000a_MAX(CASE p.seq WHEN 4 THEN p.LastAwd END) AS pi4_last_awd,_x000d__x000a_MAX(CASE p.seq WHEN 4 THEN p.pi_emai_addr END) AS pi4_email,_x000d__x000a_MAX(CASE p.seq WHEN 4 THEN p.inst_shrt_name END) AS pi4_inst_x000d__x000a_, MAX(CASE p.seq WHEN 5 THEN p.pi_last_name END) AS pi5_last_name,_x000d__x000a_MAX(CASE p.seq WHEN 5 THEN p.bio_pg END) AS pi5_bio_pg,_x000d__x000a_max(CASE p.seq WHEN 5 THEN p.coa_pg END) AS pi5_coa_pg,_x000d__x000a_MAX(CASE p.seq WHEN 5 THEN p.cp_chk END) AS pi5_cp_chk,_x000d__x000a_MAX(CASE p.seq WHEN 5 THEN p.NumAwd END) AS pi5_num_awd,_x000d__x000a_MAX(CASE p.seq WHEN 5 THEN p.LastAwd END) AS pi5_last_awd,_x000d__x000a_MAX(CASE p.seq WHEN 5 THEN p.pi_emai_addr END) AS pi5_email,_x000d__x000a_MAX(CASE p.seq WHEN 5 THEN p.inst_shrt_name END) AS pi5_inst_x000d__x000a_, MAX(CASE p.seq WHEN 6 THEN p.pi_last_name END) AS pi6_last_name,_x000d__x000a_MAX(CASE p.seq WHEN 6 THEN p.bio_pg END) AS pi6_bio_pg,_x000d__x000a_max(CASE p.seq WHEN 6 THEN p.coa_pg END) AS pi6_coa_pg,_x000d__x000a_MAX(CASE p.seq WHEN 6 THEN p.cp_chk END) AS pi6_cp_chk,_x000d__x000a_MAX(CASE p.seq WHEN 6 THEN p.NumAwd END) AS pi6_num_awd,_x000d__x000a_MAX(CASE p.seq WHEN 6 THEN p.LastAwd END) AS pi6_last_awd,_x000d__x000a_MAX(CASE p.seq WHEN 6 THEN p.pi_emai_addr END) AS pi6_email,_x000d__x000a_MAX(CASE p.seq WHEN 6 THEN p.inst_shrt_name END) AS pi6_inst_x000d__x000a_, MAX(CASE p.seq WHEN 7 THEN p.pi_last_name END) AS pi7_last_name,_x000d__x000a_MAX(CASE p.seq WHEN 7 THEN p.bio_pg END) AS pi7_bio_pg,_x000d__x000a_max(CASE p.seq WHEN 7 THEN p.coa_pg END) AS pi7_coa_pg,_x000d__x000a_MAX(CASE p.seq WHEN 7 THEN p.cp_chk END) AS pi7_cp_chk,_x000d__x000a_MAX(CASE p.seq WHEN 7 THEN p.NumAwd END) AS pi7_num_awd,_x000d__x000a_MAX(CASE p.seq WHEN 7 THEN p.LastAwd END) AS pi7_last_awd,_x000d__x000a_MAX(CASE p.seq WHEN 7 THEN p.pi_emai_addr END) AS pi7_email,_x000d__x000a_MAX(CASE p.seq WHEN 7 THEN p.inst_shrt_name END) AS pi7_inst_x000d__x000a_, MAX(CASE p.seq WHEN 8 THEN p.pi_last_name END) AS pi8_last_name,_x000d__x000a_MAX(CASE p.seq WHEN 8 THEN p.bio_pg END) AS pi8_bio_pg,_x000d__x000a_max(CASE p.seq WHEN 8 THEN p.coa_pg END) AS pi8_coa_pg,_x000d__x000a_MAX(CASE p.seq WHEN 8 THEN p.cp_chk END) AS pi8_cp_chk,_x000d__x000a_MAX(CASE p.seq WHEN 8 THEN p.NumAwd END) AS pi8_num_awd,_x000d__x000a_MAX(CASE p.seq WHEN 8 THEN p.LastAwd END) AS pi8_last_awd,_x000d__x000a_MAX(CASE p.seq WHEN 8 THEN p.pi_emai_addr END) AS pi8_email,_x000d__x000a_MAX(CASE p.seq WHEN 8 THEN p.inst_shrt_name END) AS pi8_inst_x000d__x000a_, MAX(CASE p.seq WHEN 9 THEN p.pi_last_name END) AS pi9_last_name,_x000d__x000a_MAX(CASE p.seq WHEN 9 THEN p.bio_pg END) AS pi9_bio_pg,_x000d__x000a_max(CASE p.seq WHEN 9 THEN p.coa_pg END) AS pi9_coa_pg,_x000d__x000a_MAX(CASE p.seq WHEN 9 THEN p.cp_chk END) AS pi9_cp_chk,_x000d__x000a_MAX(CASE p.seq WHEN 9 THEN p.NumAwd END) AS pi9_num_awd,_x000d__x000a_MAX(CASE p.seq WHEN 9 THEN p.LastAwd END) AS pi9_last_awd,_x000d__x000a_MAX(CASE p.seq WHEN 9 THEN p.pi_emai_addr END) AS pi9_email,_x000d__x000a_MAX(CASE p.seq WHEN 9 THEN p.inst_shrt_name END) AS pi9_inst_x000d__x000a_INTO #myPiInfo FROM #myPPPseq p GROUP BY p.lead_x000d__x000a_SELECT CASE when ((SELECT distinct CASE WHEN (su.name in ('public','gyuan') and sp.action =193)  then 'True' else 'False' end as Permission FROM FLflpdb.dbo.sysusers su left outer JOIN  FLflpdb.dbo.sysprotects sp  on sp.uid = su.uid left outer JOIN FLflpdb.dbo.sysobjects so ON SU.uid=so.uid where su.name ='gyuan'))='False' then 'Need Permission' when (prop.nsf_rcvd_date &lt; '01/25/2016') THEN 'N/A'  when (mpi.NumCoas &lt;1  )then 'Missing' else cast(mpi.NumCoas as varchar) end as NumCoas, _x000d__x000a_prop.lead_prop_id, prop.prop_id, prop.pm_ibm_logn_id, prop.pgm_annc_id, prop.org_code, prop.pgm_ele_code, _x000d__x000a_gg.ggpi_trck_num as GG_track_num, gg.ggpi_rcvd_date as GG_rcvd_date, prop.nsf_rcvd_date as NSF_rcvd_date, _x000d__x000a_CASE WHEN (spcl.SPCL_ITEM_CODE='27') THEN 'Y' END as spcl_excp_flag,_x000d__x000a_prop.prop_stts_code, prop_stts_pars.prop_stts_abbr as prop_stts, ppi.pi_last_name, ppi.pi_frst_name, ppi.pi_emai_addr,_x000d__x000a_INST.inst_shrt_name AS inst_name, INST.st_code, prop.prop_titl_txt, CASE WHEN(CHARINDEX('GOALI',UPPER(prop.prop_titl_txt))&gt;0) THEN 'Y' END AS GOALI_flag,_x000d__x000a_natr_rqst.natr_rqst_txt, prop_stts_pars.prop_stts_txt, prop.cert_dbar_sus_flag, prop_covr.OTH_AGCY_SUBM_FLAG, PROP_COVR.auth_rep_elec_sign, PROP_COVR.AUTH_REP_CERT_DATE,_x000d__x000a_CASE WHEN PROJ_DESC.PDF_PAGE_CNT&gt;0 THEN CAST(PROJ_DESC.PDF_PAGE_CNT AS varchar(4)) ELSE 'No PD' END AS ProjDesc,_x000d__x000a_CASE WHEN (proj_summ.PDF_PAGE_CNT&gt;0 AND proj_summ.SPCL_CHAR_PDF='Y') THEN 'TBC'_x000d__x000a_WHEN ((proj_summ.PDF_PAGE_CNT&lt;0 OR proj_summ.PDF_PAGE_CNT IS NULL) AND proj_summ.SPCL_CHAR_PDF='Y') THEN 'No PS' END AS ProjSumm,_x000d__x000a_CASE WHEN proj_summ.SPCL_CHAR_PDF='Y' THEN proj_summ.PDF_PAGE_CNT END as 'proj_summ_pg',_x000d__x000a_(SELECT SUM(BUDG_EXPL.PDF_PAGE_CNT) FROM flp.BUDG_EXPL BUDG_EXPL WHERE c.TEMP_PROP_ID = BUDG_EXPL.TEMP_PROP_ID)  AS 'budg_just_pg',_x000d__x000a_CASE WHEN (NOT EXISTS ( select 1 from flp.bibl  B where B.TEMP_PROP_ID = c.TEMP_PROP_ID_x000d__x000a_AND ((B.path_name is not null and  isnull((ltrim(rtrim(path_name))),'') != '') OR ( B.BIBL_TXT NOT LIKE '' AND CHAR_LENGTH(B.BIBL_TXT) IS NOT NULL))))_x000d__x000a_THEN 'No RC' ELSE CAST(bibl.PDF_PAGE_CNT AS varchar(4)) END as RefCited,_x000d__x000a_CASE WHEN (mbt.tot_Pdoc_dol&gt;0) AND (Not exists ( select 1 from  flp.ment_plan_doc B  where B.TEMP_PROP_ID = c.TEMP_PROP_ID AND B.PATH_NAME IS NOT NULL and  B.PATH_NAME &lt;&gt;  '') )_x000d__x000a_THEN 'No MP' ELSE CAST(ment.PDF_PAGE_CNT AS varchar(4)) END as MentPlan,_x000d__x000a_CASE WHEN( not exists ( select 1 from flp.dmp_plan_doc B where B.TEMP_PROP_ID = c.TEMP_PROP_ID AND B.PATH_NAME IS NOT NULL and  B.PATH_NAME&lt;&gt;'') )_x000d__x000a_THEN 'No DMP' ELSE CAST(dmp.PDF_PAGE_CNT AS varchar(4)) END as DMP,_x000d__x000a_CASE WHEN (prop.rcom_awd_istr not in ('5','8','9','C','P','7') and prop.natr_rqst_code not in ('A','5','F','2','X') and prop.obj_clas_code &lt;&gt;'4160'_x000d__x000a_AND  not exists (SELECT 1 FROM flp.prop_subm_ctl ct, flp.fac_equp a WHERE prop.prop_id = ct.prop_id and ct.temp_prop_id = a.temp_prop_id) )_x000d__x000a_THEN 'No FAC' END as FacilitiesEquip,_x000d__x000a_mt.dif_titl_collab, mt.tot_rqst_dol, nullif(mbt.tot_Part_Stipend,0) AS tot_Part_Stipend, nullif(mbt.tot_Pdoc_dol,0) AS tot_Pdoc_dol, mcbt.cumulative_tot_dol,_x000d__x000a_nullif(mcbt.cumulative_tot_dol-isnull(mt.tot_rqst_dol,0),0) AS Diff_tot_dol, msupp.oth_supp_cnt, getdate() as run_date, _x000d__x000a_mpi.*_x000d__x000a_FROM #myPiInfo mpi_x000d__x000a_LEFT OUTER JOIN #myBudgTotals mbt ON mpi.lead = mbt.lead_x000d__x000a_LEFT OUTER JOIN #myTotals mt ON mpi.lead = mt.lead_x000d__x000a_LEFT OUTER JOIN #myCumBudgTotals mcbt ON mpi.lead = mcbt.lead_x000d__x000a_LEFT OUTER JOIN #mySupp msupp ON mpi.lead=msupp.lead_x000d__x000a_JOIN flp.prop_pars prop ON mpi.lead = prop.prop_id_x000d__x000a_JOIN flp.prop_subm_ctl c ON mpi.lead = c.PROP_ID_x000d__x000a_JOIN flp.INST INST ON prop.inst_id = INST.inst_id_x000d__x000a_JOIN flp.pi ppi ON prop.pi_id = ppi.pi_id_x000d__x000a_LEFT OUTER JOIN flp.prop_stts_pars prop_stts_pars ON prop.prop_stts_code = prop_stts_pars.prop_stts_code_x000d__x000a_LEFT OUTER JOIN rptdb.csd.natr_rqst natr_rqst ON prop.natr_rqst_code = natr_rqst.natr_rqst_code_x000d__x000a_LEFT OUTER JOIN flp.PROP_COVR PROP_COVR ON c.TEMP_PROP_ID = PROP_COVR.TEMP_PROP_ID_x000d__x000a_LEFT OUTER JOIN (select TEMP_PROP_ID, SPCL_ITEM_CODE from flp.PROP_SPCL_ITEM where SPCL_ITEM_CODE ='27') spcl on c.TEMP_PROP_ID=spcl.TEMP_PROP_ID_x000d__x000a_LEFT OUTER JOIN flp.proj_summ proj_summ ON c.TEMP_PROP_ID = proj_summ.TEMP_PROP_ID_x000d__x000a_LEFT OUTER JOIN flp.PROJ_DESC PROJ_DESC ON c.TEMP_PROP_ID = PROJ_DESC.TEMP_PROP_ID_x000d__x000a_LEFT OUTER JOIN flp.bibl bibl ON c.TEMP_PROP_ID = bibl.TEMP_PROP_ID_x000d__x000a_LEFT OUTER JOIN flp.FAC_EQUP FAC_EQUP ON c.TEMP_PROP_ID = FAC_EQUP.TEMP_PROP_ID_x000d__x000a_LEFT OUTER JOIN flp.ggpi_trck gg on c.TEMP_PROP_ID=gg.temp_prop_id_x000d__x000a_LEFT OUTER JOIN flp.MENT_PLAN_DOC ment on c.TEMP_PROP_ID = ment.TEMP_PROP_ID_x000d__x000a_LEFT OUTER JOIN flp.DMP_PLAN_DOC dmp on c.TEMP_PROP_ID = dmp.TEMP_PROP_ID_x000d__x000a_ORDER BY prop.lead_prop_id, prop.prop_id _x000d__x000a_DROP TABLE #myPPPseq_x000d__x000a_DROP TABLE #myCumBudgTotals_x000d__x000a_DROP TABLE #myBudgTotals_x000d__x000a_DROP TABLE #myTotals_x000d__x000a_DROP TABLE #myPiInfo_x000d__x000a_DROP TABLE #mySupp_x000d__x000a_"/><parameters count="1"><parameter name=""/></parameters></connection><connection id="3" name="Query from RPTSERVER - for proposals" type="1" refreshedVersion="6" background="1" saveData="1"><dbPr connection="dsn=RPTSERVER;database=FLflpdb;server=RPTSQL.nsf.gov;port=5000;UID=gyuan;" command="SET NOCOUNT ON_x000d__x000a_SELECT DISTINCT isnull(prop.lead_prop_id,prop.prop_id) as lead_x000d__x000a_INTO #myLeads -- get distinct project leads fm input list_x000d__x000a_FROM flp.prop_pars prop_x000d__x000a_WHERE (prop.prop_id In ('1624020','1627342','1627343','1627350','1624004','1624023','1733610','1630480'))_x000d__x000a__x000d__x000a_SELECT CASE WHEN prop.lead_prop_id IS NULL THEN 'I' ELSE 'L' END as ILN,_x000d__x000a_ml.lead AS lead, prop.prop_id, c.TEMP_PROP_ID, prop.nsf_rcvd_date, prop.rqst_dol, prop.prop_titl_txt, prop.pi_id_x000d__x000a_INTO #myProjPropPI -- start with project leads_x000d__x000a_FROM #myLeads ml, flp.prop_pars prop, flp.prop_subm_ctl c_x000d__x000a_WHERE ml.lead = prop.prop_id AND prop.prop_id = c.PROP_ID -- add other filters here?_x000d__x000a_DROP TABLE #myLeads_x000d__x000a_INSERT INTO #myProjPropPI -- add all collabs_x000d__x000a_SELECT 'N' AS ILN, prop.lead_prop_id AS lead, prop.prop_id, c.TEMP_PROP_ID, prop.nsf_rcvd_date, prop.rqst_dol, prop.prop_titl_txt, prop.pi_id_x000d__x000a_FROM #myProjPropPI ppp, flp.prop_pars prop, flp.prop_subm_ctl c_x000d__x000a_WHERE ppp.PROP_ID = prop.lead_prop_id And ppp.PROP_ID &lt;&gt; prop.PROP_ID And prop.PROP_ID = c.PROP_ID_x000d__x000a_SELECT tp.ILN, prop.lead_prop_id, prop.prop_id, tp.TEMP_PROP_ID, prop.pm_ibm_logn_id, prop.pgm_annc_id,prop.org_code, prop.pgm_ele_code,_x000d__x000a_CASE WHEN prop.org_code &lt;&gt; prop.orig_org_code THEN prop.orig_org_code END AS orig_org_code, _x000d__x000a_CASE WHEN prop.pgm_ele_code &lt;&gt; prop.orig_pgm_ele_code THEN prop.orig_pgm_ele_code END AS orig_pgm_ele_code,_x000d__x000a_prop.nsf_rcvd_date , prop.rqst_dol, prop.prop_titl_txt, prop.pi_id, prop.prop_stts_code, prop.natr_rqst_code, prop.rcom_awd_istr, prop.obj_clas_code, prop.cert_dbar_sus_flag, prop.inst_id_x000d__x000a_INTO #myProps_x000d__x000a_FROM #myProjPropPI tp JOIN flp.prop_pars prop ON tp.prop_id = prop.PROP_ID_x000d__x000a_SELECT prop1.prop_id, COUNT(prop1.pi_id) AS tot_PIs, SUM(rqst_dol) AS tot_rqst_dol_x000d__x000a_INTO #myTotals_x000d__x000a_FROM (SELECT prop.prop_id, prop.pi_id, prop.rqst_dol FROM #myProps prop_x000d__x000a_Union_x000d__x000a_SELECT prop.prop_id, addl.pi_id,0 AS rqst_dol FROM flp.addl_pi_invl_pars addl JOIN #myProps prop ON addl.prop_id = prop.prop_id) prop1_x000d__x000a_GROUP BY prop1.prop_id_x000d__x000a_SELECT prop.prop_id, Sum(budg.PDOC_REQ_DOL) as tot_Pdoc_dol, Sum(budg.PART_SUPT_STPD_DOL) AS tot_Part_Stipend_x000d__x000a_INTO #myBudgTotal_x000d__x000a_FROM flp.budg budg JOIN #myProps prop ON budg.TEMP_PROP_ID = prop.TEMP_PROP_ID_x000d__x000a_GROUP BY prop.prop_id_x000d__x000a_SELECT prop.prop_id, count(dtls.supp_doc_seq) as oth_supp_cnt INTO #mySupp_x000d__x000a_FROM flp.supp_dtls dtls JOIN #myProps prop ON dtls.TEMP_PROP_ID = prop.TEMP_PROP_ID GROUP BY prop.prop_id _x000d__x000a_SELECT b.prop_id, b.revn_num, SUM(b.budg_tot_dol) AS cumulative_tot_dol_x000d__x000a_INTO #myCumBudgTotals FROM #myProps prop_x000d__x000a_JOIN rptdb.csd.eps_blip b ON prop.prop_id = b.PROP_ID_x000d__x000a_WHERE b.revn_num = 0  GROUP BY b.prop_id, b.revn_num_x000d__x000a_SELECT prop.ILN, prop.lead_prop_id, prop.prop_id, prop.pm_ibm_logn_id, prop.pgm_annc_id, prop.org_code, prop.pgm_ele_code, _x000d__x000a_prop.orig_org_code, prop.orig_pgm_ele_code, org1.dir_div_abbr, pe1.pgm_ele_name, org2.dir_div_abbr as orig_dir_div_abbr, pe2.pgm_ele_name as orig_pgm_ele_name, _x000d__x000a_CASE WHEN (gg.ggpi_rcvd_date is NULL AND INST.last_updt_tmsp&gt;prop.nsf_rcvd_date) THEN INST.last_updt_tmsp _x000d__x000a_WHEN (gg.ggpi_rcvd_date&lt;&gt;NULL AND INST.last_updt_tmsp&gt;gg.ggpi_rcvd_date) THEN INST.last_updt_tmsp END as inst_last_updt_tmsp,_x000d__x000a_CASE when ((SELECT distinct CASE WHEN (su.name in ('public','gyuan') and sp.action =193)  then 'True' else 'False' end FROM FLflpdb.dbo.sysusers su left outer JOIN  FLflpdb.dbo.sysprotects sp  on sp.uid = su.uid left outer JOIN FLflpdb.dbo.sysobjects so ON SU.uid=so.uid where su.name ='gyuan'))='False' then 'Need permission: tz_ctry_map' WHEN (gg.ggpi_rcvd_date is NULL AND INST.last_updt_tmsp&gt;prop.nsf_rcvd_date) THEN t.tz_name_x000d__x000a_WHEN (gg.ggpi_rcvd_date&lt;&gt;NULL AND INST.last_updt_tmsp&gt;gg.ggpi_rcvd_date) THEN t.tz_name END AS inst_timeZone,_x000d__x000a_gg.ggpi_trck_num as GG_track_num, gg.ggpi_rcvd_date as GG_rcvd_date, prop.nsf_rcvd_date as NSF_rcvd_date,_x000d__x000a_CASE WHEN (spcl.SPCL_ITEM_CODE='27') THEN 'Y' END as spcl_excp_flag,_x000d__x000a_prop.prop_stts_code, prop_stts_pars.prop_stts_abbr as prop_stts, ppi.pi_last_name, ppi.pi_frst_name, INST.inst_shrt_name AS inst_name, INST.st_code as inst_st_code, perf_org.perf_org_txt,pi_degr_yr,_x000d__x000a_prop.prop_titl_txt, CASE WHEN(CHARINDEX('GOALI',UPPER(prop.prop_titl_txt))&gt;0) THEN 'Y' END AS GOALI_flag,_x000d__x000a_natr_rqst.natr_rqst_txt, prop_stts_pars.prop_stts_txt,_x000d__x000a_prop.cert_dbar_sus_flag, prop_covr.OTH_AGCY_SUBM_FLAG, PROP_COVR.auth_rep_elec_sign, PROP_COVR.AUTH_REP_CERT_DATE,_x000d__x000a_CASE WHEN PROP_COVR.HUM_DATE is not NULL THEN convert(varchar(10),PROP_COVR.HUM_DATE,1) WHEN PROP_COVR.humn_date_pend_flag='Y' THEN 'Pend' END AS humn_date,_x000d__x000a_CASE WHEN PROP_COVR.VERT_DATE is not NULL THEN convert(varchar(10),PROP_COVR.VERT_DATE,1) WHEN PROP_COVR.vrtb_date_pend_flag='Y' THEN 'Pend' END AS vrtb_date,_x000d__x000a_CASE WHEN ILN='N' THEN 'N/A' WHEN (ILN&lt;&gt;'N' AND PROJ_DESC.PDF_PAGE_CNT&gt;0) THEN CAST(PROJ_DESC.PDF_PAGE_CNT AS varchar(4)) ELSE 'No PD' END AS ProjDesc,_x000d__x000a_CASE WHEN (ILN='N') THEN 'N/A' WHEN (ILN&lt;&gt;'N' AND proj_summ.PDF_PAGE_CNT&gt;0 AND proj_summ.SPCL_CHAR_PDF='Y') THEN 'TBC'_x000d__x000a_WHEN (ILN&lt;&gt;'N' AND (proj_summ.PDF_PAGE_CNT&lt;0 OR proj_summ.PDF_PAGE_CNT IS NULL) AND proj_summ.SPCL_CHAR_PDF='Y') THEN 'No PS' END AS ProjSumm,_x000d__x000a_CASE WHEN proj_summ.SPCL_CHAR_PDF='Y' THEN proj_summ.PDF_PAGE_CNT END as 'proj_summ_pg',(SELECT SUM(BUDG_EXPL.PDF_PAGE_CNT) FROM flp.BUDG_EXPL BUDG_EXPL WHERE prop.TEMP_PROP_ID = BUDG_EXPL.TEMP_PROP_ID)  AS 'budg_just_pg',_x000d__x000a_CASE WHEN (NOT EXISTS ( select 1 from flp.bibl  B where B.TEMP_PROP_ID = prop.TEMP_PROP_ID_x000d__x000a_AND ((B.path_name is not null and  isnull((ltrim(rtrim(path_name))),'') != '') OR ( B.BIBL_TXT NOT LIKE '' AND CHAR_LENGTH(B.BIBL_TXT) IS NOT NULL))))_x000d__x000a_THEN 'No RC' ELSE CAST(bibl.PDF_PAGE_CNT AS varchar(4)) END as RefCited,_x000d__x000a_CASE WHEN (mb.tot_Pdoc_dol&gt;0) AND (Not exists ( select 1 from  flp.ment_plan_doc B  where B.TEMP_PROP_ID = prop.TEMP_PROP_ID AND B.PATH_NAME IS NOT NULL and  B.PATH_NAME &lt;&gt;  '') )_x000d__x000a_THEN 'No MP' ELSE CAST(ment.PDF_PAGE_CNT AS varchar(4)) END as MentPlan,_x000d__x000a_CASE WHEN( not exists ( select 1 from flp.dmp_plan_doc B where B.TEMP_PROP_ID = prop.TEMP_PROP_ID AND B.PATH_NAME IS NOT NULL and  B.PATH_NAME&lt;&gt;'') )_x000d__x000a_THEN 'No DMP' ELSE CAST(dmp.PDF_PAGE_CNT AS varchar(4)) END as DMP,_x000d__x000a_CASE WHEN (prop.rcom_awd_istr not in ('5','8','9','C','P','7') and prop.natr_rqst_code not in ('A','5','F','2','X') and prop.obj_clas_code &lt;&gt;'4160'_x000d__x000a_AND  not exists (SELECT 1 FROM flp.prop_subm_ctl ct, flp.fac_equp a WHERE prop.prop_id = ct.prop_id and ct.temp_prop_id = a.temp_prop_id) )THEN 'No FAC' END as FacilitiesEquip,_x000d__x000a_mt.tot_PIs, mt.tot_rqst_dol, nullif(mb.tot_Part_Stipend,0) AS tot_Part_Stipend, nullif(mb.tot_Pdoc_dol,0) AS tot_Pdoc_dol, mc.cumulative_tot_dol,_x000d__x000a_nullif(mc.cumulative_tot_dol-isnull(mt.tot_rqst_dol,0),0) as Diff_tot_dol, supp.oth_supp_cnt, getdate() as run_date _x000d__x000a_FROM #myProps prop_x000d__x000a_JOIN flp.pi ppi ON prop.pi_id=ppi.pi_id_x000d__x000a_JOIN flp.org org1 ON prop.org_code=org1.org_code_x000d__x000a_JOIN flp.pgm_ele pe1 ON prop.pgm_ele_code=pe1.pgm_ele_code_x000d__x000a_LEFT OUTER JOIN flp.org org2 ON prop.orig_org_code=org2.org_code_x000d__x000a_LEFT OUTER JOIN flp.pgm_ele pe2 ON prop.orig_pgm_ele_code=pe2.pgm_ele_code_x000d__x000a_LEFT OUTER JOIN flp.inst_pars INST ON prop.inst_id = INST.inst_id_x000d__x000a_LEFT OUTER JOIN rptdb.csd.perf_org perf_org ON perf_org.perf_org_code = INST.perf_org_code_x000d__x000a_LEFT OUTER JOIN flp.tz_ctry_map t ON inst.inst_tz_id=t.tz_id_x000d__x000a_LEFT OUTER JOIN flp.prop_stts_pars prop_stts_pars ON prop.prop_stts_code = prop_stts_pars.prop_stts_code_x000d__x000a_LEFT OUTER JOIN rptdb.csd.natr_rqst natr_rqst ON prop.natr_rqst_code = natr_rqst.natr_rqst_code_x000d__x000a_LEFT OUTER JOIN flp.PROP_COVR PROP_COVR ON prop.TEMP_PROP_ID = PROP_COVR.TEMP_PROP_ID_x000d__x000a_LEFT OUTER JOIN (select TEMP_PROP_ID, SPCL_ITEM_CODE from flp.PROP_SPCL_ITEM where SPCL_ITEM_CODE ='27') spcl on prop.TEMP_PROP_ID=spcl.TEMP_PROP_ID_x000d__x000a_LEFT OUTER JOIN flp.proj_summ proj_summ ON prop.TEMP_PROP_ID = proj_summ.TEMP_PROP_ID_x000d__x000a_LEFT OUTER JOIN flp.PROJ_DESC PROJ_DESC ON prop.TEMP_PROP_ID = PROJ_DESC.TEMP_PROP_ID_x000d__x000a_LEFT OUTER JOIN flp.bibl bibl ON prop.TEMP_PROP_ID = bibl.TEMP_PROP_ID_x000d__x000a_LEFT OUTER JOIN flp.ggpi_trck gg on prop.TEMP_PROP_ID=gg.TEMP_PROP_ID_x000d__x000a_LEFT OUTER JOIN flp.MENT_PLAN_DOC ment on prop.TEMP_PROP_ID = ment.TEMP_PROP_ID_x000d__x000a_LEFT OUTER JOIN flp.DMP_PLAN_DOC dmp on prop.TEMP_PROP_ID = dmp.TEMP_PROP_ID_x000d__x000a_LEFT OUTER JOIN #myTotals mt ON prop.prop_id = mt.prop_id_x000d__x000a_LEFT OUTER JOIN #myBudgTotal mb ON prop.prop_id= mb.prop_id_x000d__x000a_LEFT OUTER JOIN #myCumBudgTotals mc ON prop.prop_id = mc.prop_id_x000d__x000a_LEFT OUTER JOIN #mySupp supp ON prop.prop_id=supp.prop_id_x000d__x000a_ORDER BY prop.lead_prop_id, prop.ILN, prop.prop_id_x000d__x000a_DROP TABLE #myProps_x000d__x000a_DROP TABLE #myTotals_x000d__x000a_DROP TABLE #myBudgTotal_x000d__x000a_DROP TABLE #myCumBudgTotals_x000d__x000a_DROP TABLE #myProjPropPI_x000d__x000a_DROP TABLE #mySupp_x000d__x000a_"/></connection></connections>